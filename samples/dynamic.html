<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
    <title>Onde Sample</title>
    <link rel="stylesheet" href="../src/onde.css" type="text/css"/>
  </head>
  <body>

<h1>Onde</h1>

<h2>Schema</h2>
<form id="launcher-form" action="">
<p>Schema URL: <input type="text" id="schema-load-input" style="width: 40em" />
<br/>Data URL: <input type="text" id="schema-load-data-url" style="width: 40em" />
<br/><button type="submit" id="schema-load-submit">Load</button></p>
</form>

<h2>Data Input</h2>
<form id="entry-form" method="post">
  <!-- Our placeholder element. Displayed before and when rendering the form. -->
  <p class="placeholder">Enter the schema URL into the above form.</p>
  <!-- The element where the generated form goes to. -->
  <div class="onde-panel"></div>
  <!-- The submit button. -->
  <p class="actions"><button type="submit" name="submit" disabled="disabled" value="dump_json">Get JSON</button></p>
</form>

<script type="application/javascript" src="jquery-1.6.3.min.js"></script>
<script type="application/javascript" src="../src/onde.js"></script>
<script type="application/javascript">
function getHashParameterByName(name)
{
  name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
  var hash = window.location.hash || '#';
  var regexS = "[\\#&]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  var results = regex.exec(hash);
  if(results == null)
    return "";
  else
    return decodeURIComponent(results[1].replace(/\+/g, " "));
}
$(document).ready(function () {
//    console.log(window.location);
    
    var schemaURL = getHashParameterByName('schema');
    var dataURL = getHashParameterByName('data');
    var formElement = $('#entry-form');
    var jform = new onde.Onde(formElement);
    function loadForm() {
        if (!schemaURL) {
            return;
        }
        function _loadImpl(schema, data) {
            formElement.find('.placeholder').text('Rendering form...').show();
            jform.render(schema, data, {
                schemaURL: schemaURL,
                dataURL: dataURL,
                renderFinished: function (element) {
                    formElement.find('.placeholder').fadeOut('fast', function () {
                        element.fadeIn('fast');
                        //formElement.find('.actions').fadeIn('fast');
                        formElement.find('.actions button').removeAttr('disabled');
                        });
                    }
                });
        };
        formElement.find('.actions button').attr('disabled', 'disabled');
        formElement.find('.onde-panel').text('').hide();
        formElement.find('.placeholder').text('Loading schema...').show();
        $.getJSON(schemaURL, function (schema) {
            if (dataURL) {
                formElement.find('.placeholder').text('Loading data...').show();
                $.getJSON(dataURL, function (data) { _loadImpl(schema, data); });
            } else {
                _loadImpl(schema, null);
            }
        });
        // Listen to form submit
        formElement.submit(function (evt) {
            evt.preventDefault();
            var outData = jform.getData();
            if (outData.errorCount) {
                //TODO: Show message (use content) and cancel submit
                alert("Error submitting data. Number of errors: " + outData.errorCount);
                console.log(outData);
            } else {
                //TODO: Submit the result
                //console.log(outData.data);
                $('#json-output').text(JSON.stringify(outData.data, null, "  "));
                //$.post("http://localhost:29017/test/test/_insert", { data: JSON.stringify(outData.data) }, null, 'json');
            }
            return false;
        });
    }
    $('#launcher-form').submit(function (evt) {
        evt.preventDefault();
        schemaURL = $('#schema-load-input').val();
        dataURL = $('#schema-load-data-url').val();
        if (!schemaURL) {
            alert("No schema URL provided");
            return false;
        }
        //TODO: Change the current location appropriately
        loadForm();
        return false;
    });
    $('#schema-load-input').val(schemaURL);
    $('#schema-load-data-url').val(dataURL);
    loadForm();
});
</script>

<h2>Output</h2>
<pre id="json-output" style="overflow: auto; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f3f3f3"></pre>

  </body>
</html>
